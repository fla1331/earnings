// ====================================================
// CORRE√á√ÉO SEO
// ====================================================
// Este script faz:
// 1. Corrige canonical em TODAS as p√°ginas
// 2. Remove noindex
// 3. Adiciona meta robots
// 4. Cria sitemap.xml automaticamente
// 5. Mostra relat√≥rio completo
// ====================================================

const fs = require('fs');
const path = require('path');

// ========== CONFIGURA√á√ÉO ==========
const CONFIG = {
  SITE_URL: 'https://earnings.reviewnexus.blog',
  PASTA_RAIZ: './',
  
  // Pastas para ignorar
  PASTAS_IGNORAR: [
    'backup', 'node_modules', '__trashed',
    'includes', 'wp-content', 'author'
  ],
  
  // Arquivos para n√£o incluir no sitemap
  ARQUIVOS_IGNORAR_SITEMAP: [
    'indexcopy.html',
    /weight-loss-quiz/,
    /teste[s]?/,
    /page\/\d+\//  // Pagina√ß√£o: page/2, page/3, etc
  ]
};

// ========== FUN√á√ïES AUXILIARES ==========
function log(mensagem, tipo = 'info') {
  const prefixos = { info: 'üìù', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', sitemap: 'üó∫Ô∏è' };
  console.log(`${prefixos[tipo] || 'üìù'} ${mensagem}`);
}

function encontrarTodosArquivosHTML() {
  const arquivos = [];
  
  function buscar(pasta) {
    try {
      const itens = fs.readdirSync(pasta, { withFileTypes: true });
      
      for (const item of itens) {
        const caminhoCompleto = path.join(pasta, item.name);
        
        if (item.isDirectory()) {
          // Verifica se deve ignorar esta pasta
          if (!CONFIG.PASTAS_IGNORAR.includes(item.name)) {
            buscar(caminhoCompleto);
          }
        } else if (item.name.endsWith('.html')) {
          arquivos.push({
            caminhoCompleto,
            caminhoRelativo: path.relative(CONFIG.PASTA_RAIZ, caminhoCompleto).replace(/\\/g, '/'),
            nomeArquivo: item.name,
            pasta: path.dirname(path.relative(CONFIG.PASTA_RAIZ, caminhoCompleto))
          });
        }
      }
    } catch (erro) {
      log(`Erro ao buscar em ${pasta}: ${erro.message}`, 'error');
    }
  }
  
  buscar(CONFIG.PASTA_RAIZ);
  return arquivos;
}

function gerarURLCorreta(arquivoInfo) {
  const { caminhoRelativo, nomeArquivo } = arquivoInfo;
  
  // Se for index.html na raiz
  if (caminhoRelativo === 'index.html') {
    return `${CONFIG.SITE_URL}/`;
  }
  
  // Se for um index.html dentro de uma pasta
  if (nomeArquivo === 'index.html') {
    const pasta = path.dirname(caminhoRelativo);
    return pasta === '.' ? `${CONFIG.SITE_URL}/` : `${CONFIG.SITE_URL}/${pasta}/`;
  }
  
  // Para outros arquivos HTML (raro no seu caso)
  return `${CONFIG.SITE_URL}/${caminhoRelativo.replace('.html', '')}`;
}

function deveIncluirNoSitemap(arquivoInfo) {
  const { caminhoRelativo, nomeArquivo } = arquivoInfo;
  
  // S√≥ inclui index.html no sitemap
  if (nomeArquivo !== 'index.html') return false;
  
  // Verifica se est√° na lista de ignorar
  for (const padrao of CONFIG.ARQUIVOS_IGNORAR_SITEMAP) {
    if (typeof padrao === 'string' && caminhoRelativo.includes(padrao)) {
      return false;
    }
    if (padrao instanceof RegExp && padrao.test(caminhoRelativo)) {
      return false;
    }
  }
  
  // Verifica se est√° em pasta ignorada
  for (const pasta of CONFIG.PASTAS_IGNORAR) {
    if (caminhoRelativo.includes(pasta + '/')) {
      return false;
    }
  }
  
  return true;
}

// ========== CORRE√á√ÉO DAS P√ÅGINAS HTML ==========
function corrigirPaginasHTML(arquivosHTML) {
  log(`Encontrados ${arquivosHTML.length} arquivos HTML`, 'info');
  log('Iniciando corre√ß√£o das p√°ginas...', 'info');
  console.log('='.repeat(60));
  
  let paginasCorrigidas = 0;
  let problemasEncontrados = 0;
  const backupDir = './backup_automatico';
  
  // Cria backup se n√£o existir
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir, { recursive: true });
    log(`Pasta de backup criada: ${backupDir}`, 'warning');
  }
  
  for (const [index, arquivo] of arquivosHTML.entries()) {
    try {
      const conteudoOriginal = fs.readFileSync(arquivo.caminhoCompleto, 'utf8');
      const urlCorreta = gerarURLCorreta(arquivo);
      let novoConteudo = conteudoOriginal;
      let mudancas = [];
      
      // 1. CORRIGIR NOINDEX
      if (conteudoOriginal.includes('noindex')) {
        novoConteudo = novoConteudo
          .replace(/content="noindex,follow"/gi, 'content="index,follow"')
          .replace(/content="noindex"/gi, 'content="index,follow"')
          .replace(/content='noindex'/gi, 'content="index,follow"');
        mudancas.push('noindex corrigido');
        problemasEncontrados++;
      }
      
      // 2. CORRIGIR/ADICIONAR CANONICAL
      const regexCanonical = /<link[^>]*rel="canonical"[^>]*>/gi;
      const canonicalCorreto = `<link rel="canonical" href="${urlCorreta}" />`;
      
      if (regexCanonical.test(novoConteudo)) {
        // Verifica se o canonical atual est√° errado
        const canonicalAtual = novoConteudo.match(regexCanonical)[0];
        if (!canonicalAtual.includes(urlCorreta)) {
          novoConteudo = novoConteudo.replace(regexCanonical, canonicalCorreto);
          mudancas.push('canonical atualizado');
        }
      } else {
        // Adiciona canonical se n√£o existir
        if (novoConteudo.includes('</head>')) {
          novoConteudo = novoConteudo.replace('</head>', `\n  ${canonicalCorreto}\n</head>`);
          mudancas.push('canonical adicionado');
        }
      }
      
      // 3. ADICIONAR META ROBOTS SE N√ÉO EXISTIR
      if (!novoConteudo.includes('name="robots"')) {
        const metaRobots = '<meta name="robots" content="index, follow, max-image-preview:large" />';
        if (novoConteudo.includes('<head>')) {
          novoConteudo = novoConteudo.replace('<head>', `<head>\n  ${metaRobots}`);
          mudancas.push('meta robots adicionada');
        }
      }
      
      // 4. ADICIONAR VIEWPORT (opcional, mas recomendado)
      if (!novoConteudo.includes('name="viewport"')) {
        const viewport = '<meta name="viewport" content="width=device-width, initial-scale=1">';
        novoConteudo = novoConteudo.replace('<head>', `<head>\n  ${viewport}`);
      }
      
      // Salva as altera√ß√µes se houver mudan√ßas
      if (novoConteudo !== conteudoOriginal) {
        // Faz backup primeiro
        const backupPath = path.join(backupDir, arquivo.caminhoRelativo);
        const backupDirPath = path.dirname(backupPath);
        if (!fs.existsSync(backupDirPath)) {
          fs.mkdirSync(backupDirPath, { recursive: true });
        }
        fs.writeFileSync(backupPath, conteudoOriginal, 'utf8');
        
        // Salva arquivo corrigido
        fs.writeFileSync(arquivo.caminhoCompleto, novoConteudo, 'utf8');
        paginasCorrigidas++;
        
        // Mostra progresso a cada 20 arquivos ou se tiver mudan√ßas importantes
        if (mudancas.length > 0 || (index + 1) % 20 === 0) {
          console.log(`${index + 1}/${arquivosHTML.length}: ${arquivo.caminhoRelativo}`);
          if (mudancas.length > 0) {
            console.log(`   ‚Üí ${mudancas.join(', ')}`);
            console.log(`   üîó ${urlCorreta}`);
          }
        }
      }
      
    } catch (erro) {
      log(`Erro ao processar ${arquivo.caminhoRelativo}: ${erro.message}`, 'error');
    }
  }
  
  console.log('='.repeat(60));
  log(`P√°ginas corrigidas: ${paginasCorrigidas}`, 'success');
  log(`Problemas encontrados: ${problemasEncontrados}`, problemasEncontrados > 0 ? 'warning' : 'success');
  
  return { paginasCorrigidas, problemasEncontrados };
}

// ========== CRIAR SITEMAP ==========
function criarSitemapXML(arquivosHTML) {
  log('Criando sitemap.xml...', 'sitemap');
  
  // Filtra apenas os arquivos para o sitemap
  const arquivosSitemap = arquivosHTML.filter(deveIncluirNoSitemap);
  log(`${arquivosSitemap.length} p√°ginas ser√£o inclu√≠das no sitemap`, 'info');
  
  // Ordena por import√¢ncia
  arquivosSitemap.sort((a, b) => {
    // Homepage primeiro
    if (a.caminhoRelativo === 'index.html') return -1;
    if (b.caminhoRelativo === 'index.html') return 1;
    
    // Idiomas principais: en, pt, es
    const idiomasPrincipais = ['en', 'pt', 'es'];
    const aIdioma = a.caminhoRelativo.split('/')[0];
    const bIdioma = b.caminhoRelativo.split('/')[0];
    
    const aIsPrincipal = idiomasPrincipais.includes(aIdioma);
    const bIsPrincipal = idiomasPrincipais.includes(bIdioma);
    
    if (aIsPrincipal && !bIsPrincipal) return -1;
    if (!aIsPrincipal && bIsPrincipal) return 1;
    
    // Ordena alfabeticamente
    return a.caminhoRelativo.localeCompare(b.caminhoRelativo);
  });
  
  // Gera o XML do sitemap
  const today = new Date().toISOString().split('T')[0];
  let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
  xml += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n';
  
  arquivosSitemap.forEach((arquivo, index) => {
    const url = gerarURLCorreta(arquivo);
    
    // Determina prioridade e frequ√™ncia
    let priority = '0.7';
    let changefreq = 'monthly';
    
    if (arquivo.caminhoRelativo === 'index.html') {
      priority = '1.0';
      changefreq = 'weekly';
    } else if (['en', 'pt', 'es'].includes(arquivo.caminhoRelativo.split('/')[0])) {
      priority = '0.8';
      changefreq = 'monthly';
    }
    
    // Escapa caracteres especiais para XML
    const esc = (str) => str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&apos;');
    
    xml += '  <url>\n';
    xml += `    <loc>${esc(url)}</loc>\n`;
    xml += `    <lastmod>${today}</lastmod>\n`;
    xml += `    <changefreq>${changefreq}</changefreq>\n`;
    xml += `    <priority>${priority}</priority>\n`;
    xml += '  </url>\n';
    
    // Mostra progresso
    if ((index + 1) % 20 === 0) {
      log(`Processadas ${index + 1}/${arquivosSitemap.length} URLs para sitemap`, 'info');
    }
  });
  
  xml += '</urlset>';
  
  // Salva o arquivo sitemap.xml
  fs.writeFileSync('sitemap.xml', xml, 'utf8');
  
  // Estat√≠sticas
  const stats = fs.statSync('sitemap.xml');
  log(`Sitemap criado: sitemap.xml (${(stats.size / 1024).toFixed(2)} KB)`, 'success');
  
  // Mostra algumas URLs como exemplo
  console.log('\nüìù Exemplos de URLs no sitemap:');
  arquivosSitemap.slice(0, 10).forEach((arquivo, i) => {
    const url = gerarURLCorreta(arquivo);
    console.log(`  ${i + 1}. ${url}`);
  });
  
  if (arquivosSitemap.length > 10) {
    console.log(`  ... e mais ${arquivosSitemap.length - 10} URLs`);
  }
  
  return arquivosSitemap.length;
}

// ========== VERIFICA√á√ÉO FINAL ==========
function verificarResultados(arquivosHTML, totalURLsSitemap) {
  log('Realizando verifica√ß√£o final...', 'info');
  
  console.log('\n' + '='.repeat(60));
  console.log('üîç VERIFICA√á√ÉO R√ÅPIDA');
  console.log('='.repeat(60));
  
  // Verifica algumas p√°ginas chave
  const paginasParaVerificar = [
    'index.html',
    'en/index.html',
    'pt/index.html',
    'es/index.html',
    'en/keton-aktiv-review/index.html',
    'pt/keton-aktiv-review/index.html'
  ];
  
  paginasParaVerificar.forEach(pagina => {
    try {
      const caminho = path.join(CONFIG.PASTA_RAIZ, pagina);
      if (fs.existsSync(caminho)) {
        const conteudo = fs.readFileSync(caminho, 'utf8');
        const temCanonical = conteudo.includes('rel="canonical"');
        const temNoindex = conteudo.includes('noindex');
        const temRobots = conteudo.includes('name="robots"');
        
        console.log(`\n${pagina}:`);
        console.log(`  üìç Canonical: ${temCanonical ? '‚úÖ' : '‚ùå'}`);
        console.log(`  üö´ Noindex: ${temNoindex ? '‚ùå' : '‚úÖ'}`);
        console.log(`  ü§ñ Meta robots: ${temRobots ? '‚úÖ' : '‚ùå'}`);
        
        // Mostra a URL canonical
        if (temCanonical) {
          const match = conteudo.match(/<link[^>]*rel="canonical"[^>]*href="([^"]*)"/);
          if (match) {
            console.log(`     URL: ${match[1]}`);
          }
        }
      } else {
        console.log(`\n${pagina}: ‚ùå N√£o encontrada`);
      }
    } catch (erro) {
      console.log(`\n${pagina}: ‚ùå Erro: ${erro.message}`);
    }
  });
  
  // Verifica sitemap
  console.log('\nüó∫Ô∏è SITEMAP:');
  if (fs.existsSync('sitemap.xml')) {
    const conteudo = fs.readFileSync('sitemap.xml', 'utf8');
    const count = (conteudo.match(/<loc>/g) || []).length;
    console.log(`  ‚úÖ Criado com ${count} URLs`);
  } else {
    console.log('  ‚ùå N√£o encontrado');
  }
}

// ========== EXECU√á√ÉO PRINCIPAL ==========
async function main() {
  console.log('='.repeat(60));
  console.log('üöÄ CORRE√á√ÉO SEO COMPLETA - TUDO EM UM');
  console.log('='.repeat(60));
  console.log(`üåê Site: ${CONFIG.SITE_URL}`);
  console.log(`üìÅ Pasta: ${CONFIG.PASTA_RAIZ}`);
  console.log('='.repeat(60) + '\n');
  
  // PASSO 1: Encontrar todos os arquivos HTML
  log('Buscando arquivos HTML...', 'info');
  const arquivosHTML = encontrarTodosArquivosHTML();
  
  if (arquivosHTML.length === 0) {
    log('Nenhum arquivo HTML encontrado!', 'error');
    return;
  }
  
  // PASSO 2: Corrigir todas as p√°ginas
  const { paginasCorrigidas, problemasEncontrados } = corrigirPaginasHTML(arquivosHTML);
  
  // PASSO 3: Criar sitemap
  const totalURLsSitemap = criarSitemapXML(arquivosHTML);
  
  // PASSO 4: Verifica√ß√£o final
  verificarResultados(arquivosHTML, totalURLsSitemap);
  
  // RELAT√ìRIO FINAL
  console.log('\n' + '='.repeat(60));
  console.log('üìã RELAT√ìRIO FINAL');
  console.log('='.repeat(60));
  console.log(`üìÅ Total de arquivos HTML: ${arquivosHTML.length}`);
  console.log(`üîß P√°ginas corrigidas: ${paginasCorrigidas}`);
  console.log(`‚ùå Problemas encontrados: ${problemasEncontrados}`);
  console.log(`üó∫Ô∏è URLs no sitemap: ${totalURLsSitemap}`);
  console.log(`üìÑ Sitemap: sitemap.xml`);
  console.log(`üì¶ Backup: ./backup_automatico/`);
  
  console.log('\n' + '='.repeat(60));
  console.log('üéâ TUDO CONCLU√çDO!');
  console.log('='.repeat(60));
  
  console.log('\nüëâ PR√ìXIMOS PASSOS:');
  console.log('1. Commit no GitHub:');
  console.log('   git add .');
  console.log('   git commit -m "Corre√ß√£o SEO completa: canonical, noindex, sitemap"');
  console.log('   git push');
  console.log('\n2. Netlify faz deploy autom√°tico');
  console.log('\n3. No Google Search Console:');
  console.log(`   - Remova o sitemap antigo (post-sitemap.xml)`);
  console.log(`   - Adicione o novo: ${CONFIG.SITE_URL}/sitemap.xml`);
  console.log('   - Use "Inspe√ß√£o de URL" em 3-4 p√°ginas principais');
  console.log('   - Solicite indexa√ß√£o');
  console.log('\n4. Aguarde 7-14 dias para reindexa√ß√£o completa');
  console.log('='.repeat(60));
}

// Executa tudo
main().catch(erro => {
  log(`Erro durante execu√ß√£o: ${erro.message}`, 'error');
  console.error(erro);
});